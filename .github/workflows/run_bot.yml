name: AutoTrader Notifier

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write           # allow git push from the Action

jobs:
  watch:
    runs-on: ubuntu-22.04   # ‚Üê 22.04 has libasound2, avoids the 24.04 bug
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0        # keep history so git push works

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps + Playwright browsers
        run: |
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run bot
        env: ${{ secrets }}     # exposes all repo secrets as env vars
        run: python autotrader_bot.py

      - name: Commit any updates
        run: |
          git config user.name  "autotrader-bot"
          git config user.email "actions@github.com"
          if ! git diff --quiet; then
            git add archives/** seen_listings.json
            git commit -m "Update seen listings and archives [skip ci]"
            git push
          fi
